(function(){'use strict';const $page=$('#coin-page');const coinId=$page.data('coin-id');const $loader=$('#loader');const $feedback=$('#feedback');const $detailCard=$('#coin-detail');const $chartCard=$('#chart-card');if(!coinId){showError('Missing coin id');return}$(init);async function init(){showLoader(true);try{const detail=await fetchDetail(coinId);renderDetail(detail);const history=await fetchHistory(coinId,7);renderChart(history)}catch(e){showError(e.message||'Failed to load')}finally{showLoader(false)}}function fetchDetail(id){return $.getJSON('./api/coins.php',{action:'detail',id}).then(res=>{if(!res||!res.data)throw new Error('Invalid response');return res.data})}function fetchHistory(id,days){return $.getJSON('./api/coins.php',{action:'history',id,days}).then(res=>{if(!res||!res.data)throw new Error('Invalid response');return res.data})}function renderDetail(c){const symbolLower=(c.symbol||'').toLowerCase();$('#coin-icon').attr('src',`https://assets.coincap.io/assets/icons/${symbolLower}@2x.png`).attr('alt',c.symbol||'');$('#coin-name').text(c.name||'');$('#coin-symbol').text(c.symbol?`(${c.symbol})`:'');$('#coin-price').text(money(c.priceUsd));$('#coin-cap').text(compactNumber(c.marketCapUsd));$('#coin-vol').text(compactNumber(c.volumeUsd24Hr));$('#coin-supply').text(numberFormat(c.supply));$detailCard.removeClass('d-none')}function renderChart(history){const last7=history.slice(-7);const labels=last7.map(p=>formatDate(p.time||p.date));const data=last7.map(p=>Number(p.priceUsd||0));const ctx=document.getElementById('priceChart');new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Price (USD)',data,tension:.3,pointRadius:2}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>v>=1?v.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}):'$'+Number(v).toFixed(6)}}},plugins:{legend:{display:false},tooltip:{callbacks:{label:(ctx)=>{const v=ctx.parsed.y;const s=(v>=1)?v.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}):'$'+Number(v).toFixed(6);return'Price: '+s}}}}});$chartCard.removeClass('d-none')}function money(x){const n=Number(x);if(!isFinite(n))return'-';if(n>1)return n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});if(n>0.01)return'$'+n.toLocaleString(undefined,{maximumFractionDigits:4});return'$'+n.toExponential(2)}function compactNumber(x){const n=Number(x);if(!isFinite(n))return'-';if(n>=1e12)return'$'+(n/1e12).toFixed(2)+'T';if(n>=1e9)return'$'+(n/1e9).toFixed(2)+'B';if(n>=1e6)return'$'+(n/1e6).toFixed(2)+'M';if(n>=1e3)return'$'+(n/1e3).toFixed(2)+'K';return'$'+n.toFixed(2)}function numberFormat(x){const n=Number(x);if(!isFinite(n))return'-';return n.toLocaleString()}function formatDate(t){const d=(typeof t==='number')?new Date(t):new Date(String(t));if(isNaN(d.getTime()))return'';return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}function showLoader(show){$loader.toggle(!!show)}function showError(msg){$feedback.html(`<div class='alert alert-danger' role='alert'>${escapeHtml(msg)}</div>`)}function escapeHtml(s){return String(s).replace(/[&<>\"'`=\/]/g,function(c){return{'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c]})}})();